# AuthRelay

A PHP-based authentication relay system for TP-Link Omada Controller with Keycloak/OIDC integration.

## Overview

AuthRelay acts as middleware between the TP-Link Omada Controller and a Keycloak Identity Provider. It enables external
user authentication for hotspot clients via OpenID Connect (OIDC).

## How it works

1. Omada Controller redirects clients to external authentication
2. AuthRelay initiates OIDC flow with Keycloak
3. After successful authentication, AuthRelay authorizes the client on the Omada Controller (via hotspot operator)
4. Client is redirected back to the original destination

## Features that will be available

### Keycloak/OIDC

- OpenID Connect (OIDC)
- Single Sign-On (SSO)
- Multi-factor authentication
- Role-based access control (you have to create roles and to change the browser-flow for the client)

### Omada Controller

- LAN and WLAN access control
- Hotspot management

### AuthRelay

- Additional logging
- Connection between Omada Controller and Keycloak
- Prepared for working behind a reverse proxy
- SSL verification disabled (open for self-signed certificates)

## Requirements

- Server with `Docker`-Service
- Omada `Controller` or `SDN` 5.0.15 or higher
- Keycloak

## Preparation

Variables you have to replace with your configuration:

### Keycloak Variables

- `your-keycloak-server-url` Your Keycloak URL (Examples: https://keycloak.your-domain.com // http://192.168.1.100:8080)
- `your-realm` Your realm name (where you setup the authrelay-client, for details see keyclaok documentation)
- `your-client-id` Your client ID for the authrelay-client (you will create this later)
- `your-client-secret` Will be generated by Keycloak, when you create the client

### Omada Controller Variables

- `your-omada-controller-url` Your omada controller URL (
  Examples: https://omada.your-domain.com // http://192.168.1.1:8080)
- `your-omada-site-id` Your omada controller site ID (visible in the URL when you login to the controller)
- `your-omada-operator-username` Username of the hotspot operator (you will create this later)
- `your-omada-operator-password` Password of the hotspot operator (you will create this later)

### AuthRelay Variables

- `your-relay-host-url` Your relay host URL (Examples: https://authrelay.your-domain.com // http://192.168.1.100:9999)
- `your-relay-callback-path` Callback path for the relay host (optional, default: /callback)

### Keycloak Client Configuration

Create a client in Keycloak with the following settings:

- **Client Type**: OpenID Connect
- **Client Authentication**: On
- **Authorization**: Off
- **Valid Redirect URIs**: `https://<your-relay-host.com><your-relay-calback-path>`
  Example: https://authrelay.your-domain.com/callback

Note: Copy the client secret and save it somewhere safe. (`your-client-secret`)

### Omada Controller Configuration

1. Go to **Settings → Authentication → Portal**
2. Select **External Portal Server**
3. Set Portal URL to: `<your-relay-host-url>` Example: https://authrelay.your-domain.com
4. Switch to the tab **Access Control** (on the same site)
5. Activate the Preauthentication Access option
6. Add to the **Preauthentication Access** URLs

- `<your-relay-host-url>` Example: https://authrelay.your-domain.com
- `<your-keycloak-server-url>` Example: https://keycloak.your-domain.com

7. Save the settings

#### Setup the operator credentials

1. Go to your omada site configuration
2. Select on the same menu the "Hotspot-Manager"
3. Go on the left menu to "Operators"
4. Create a new operator
5. Set the username (`your-omada-operator-username`) and password (`your-omada-operator-password`)
6. Save the operator

## Installation

### With Docker (recommended)

1. Clone the repository:

```bash
git clone <repository-url>
cd authrelay
```

2. Create environment file:

```bash
cp .env.example .env
```

3. **Configure environment variables (see below)**

4. Build and start container:

```bash
./build.sh
docker run -d --name authrelay --env-file .env -p 80:80 authrelay
```

### Also availble via Docker Compose
(not tested, but should work)

start the docker with Docker Compose:
```docker
services:
    authrelay:
        image: ghcr.io/axute/omada-keycloak-authrelay:stable
        restart: always
        envinonment:
            - KEYCLOAK_SERVER_URL=https://keycloak.your-domain.com
            - KEYCLOAK_REALM=your-realm
            - KEYCLOAK_CLIENT_ID=authrelay-client
            - KEYCLOAK_CLIENT_SECRET=your-client-secret
            - OMADA_URL=https://your-omada-controller.com
            - OMADA_SITE_ID=your-site-id
            - OMADA_HOTSPOT_OPERATOR_USERNAME=admin
            - OMADA_HOTSPOT_OPERATOR_PASSWORD=
            - RELAY_CALLBACK_PATH=/callback
        ports:
            - 80:80
```



* run the docker image with `docker run -d --name authrelay --env-file .env -p 80:80 authrelay`

## Required Environment Variables

Create a file in the project root with the following variables: `.env`

### Keycloak/OIDC Configuration

```dotenv
# Keycloak Server URL (without trailing slash)
KEYCLOAK_SERVER_URL=https://keycloak.your-domain.com

# Keycloak Realm
KEYCLOAK_REALM=your-realm

# Client Credentials
KEYCLOAK_CLIENT_ID=authrelay-client
KEYCLOAK_CLIENT_SECRET=your-client-secret
```

### Omada Controller Configuration

```dotenv
# Omada Controller URL with schema and port
OMADA_URL=https://your-omada-controller.com:8043

# Site/Controller ID
OMADA_SITE_ID=your-site-id

# Hotspot Operator Credentials
OMADA_HOTSPOT_OPERATOR_USERNAME=admin
OMADA_HOTSPOT_OPERATOR_PASSWORD=your-password
```

### Relay Host Configuration (optional)

```dotenv
# Callback path (optional, default: /callback)
RELAY_CALLBACK_PATH=/callback
```

### Session Configuration (optional)

```dotenv
# Session lifetime in seconds (default: 36000 = 10 hours)
SESSION_LIFETIME=36000
```

---
Used in this project:

- [PHP Slim-Framework](https://www.slimframework.com/) for simple routing
- [PHP Slim-Session](https://github.com/bryanjhv/slim-session) for session handling
- [PHP Guzzle Framework](https://docs.guzzlephp.org/en/stable/) for HTTP requests
- [PHP Dotenv](https://github.com/vlucas/phpdotenv) for environment variables
- [PHP Keycloak Client](https://github.com/stevenmaguire/oauth2-keycloak)
- [Omada Controller API](https://github.com/tp-link/Omada-Controller-API)
